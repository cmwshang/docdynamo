<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE doc SYSTEM "doc.dtd">
<doc title="Installation Guide - Crunchy Containers for PostgreSQL"  subtitle="Crunchy Data Solutions, Inc.">
<description>Installation Guide - Crunchy Containers for PostgreSQL</description>
<section id="_project_setup_amp_docker_installation">
<title>Project Setup &amp; Docker Installation</title>
<p>The crunchy-containers can run on different environments including:</p>
<list>
<list-item>
Docker 1.12
</list-item>
<list-item>
OpenShift Container Platform
</list-item>
<list-item>
Kubernetes 1.5+
</list-item>
</list>
<p>In this document we list the basic installation steps required for these
environments.</p>
<p>These installation instructions are developed and tested for the following operating systems:</p>
<list>
<list-item>
<b>CentOS 7</b>
</list-item>
<list-item>
<b>RHEL 7</b>
</list-item>
</list>
<section id="_project_directory_structure">
<title>Project Directory Structure</title>
<p>First add the following lines to your .bashrc file to set
the project paths:</p>
<code-block>export GOPATH=$HOME/cdev
export GOBIN=$GOPATH/bin
export PATH=$PATH:$GOBIN
export CCP_BASEOS=centos7
export CCP_PGVERSION=10
export CCP_PG_FULLVERSION=10.1
export CCP_VERSION=1.7.0
export CCP_IMAGE_PREFIX=crunchydata
export CCP_IMAGE_TAG=$CCP_BASEOS-$CCP_PG_FULLVERSION-$CCP_VERSION
export CCPROOT=$GOPATH/src/github.com/crunchydata/crunchy-containers
export CCP_CLI=kubectl
export NAMESPACE=default
export PV_PATH=/mnt/nfsfileshare
export LOCAL_IP=$(hostname --ip-address)
export REPLACE_CCP_IMAGE_PREFIX=crunchydata</code-block>
<p>It will be necessary to refresh your bashrc file in order for the changes to take
effect.</p>
<code-block>. ~/.bashrc</code-block>
<p>Next, set up a project directory structure and pull down the project:</p>
<code-block>mkdir $HOME/cdev $HOME/cdev/src $HOME/cdev/pkg $HOME/cdev/bin</code-block>
<p>At this point, if you are installing crunchy-containers on a CentOS 7 machine,
you may continue with the following instructions. If you are doing an installation
on RHEL 7, please view the instructions located
<link url="https://github.com/crunchydata/crunchy-containers/blob/master/docs/install.adoc#rhel-7">below</link>
that are specific to RHEL environments.</p>
<section id="_centos_7">
<title>CentOS 7</title>
<code-block>cd $GOPATH
sudo yum -y install golang git docker
go get github.com/tools/godep
cd src/github.com
mkdir crunchydata
cd crunchydata
git clone https://github.com/crunchydata/crunchy-containers
cd crunchy-containers
git checkout 1.7.0
godep restore</code-block>
<p><b>If you are a Crunchy enterprise customer, you will place the Crunchy repository
key and yum repository file into the $CCPROOT/conf directory at this point. These
files can be obtained through <link url="https://access.crunchydata.com/">https://access.crunchydata.com/</link> on the downloads
page.</b></p>
</section>
<section id="_rhel_7">
<title>RHEL 7</title>
<p>When setting up the environment on RHEL 7, there are slightly different steps that
need to be taken.</p>
<code-block>cd $GOPATH
sudo subscription-manager repos --enable=rhel-7-server-optional-rpms
sudo yum-config-manager --enable rhel-7-server-extras-rpms
sudo yum -y install git golang docker
go get github.com/tools/godep
cd src/github.com
mkdir crunchydata
cd crunchydata
git clone https://github.com/crunchydata/crunchy-containers
cd crunchy-containers
git checkout 1.7.0
godep restore</code-block>
<p><b>If you are a Crunchy enterprise customer, you will place the Crunchy repository
key and yum repository file into the $CCPROOT/conf directory at this point. These
files can be obtained through <link url="https://access.crunchydata.com/">https://access.crunchydata.com/</link> on the downloads
page.</b></p>
</section>
</section>
<section id="_installing_postgresql">
<title>Installing PostgreSQL</title>
<p>These installation instructions assume the installation of PostgreSQL 10
through the official PGDG repository. View the documentation located
<link url="https://wiki.postgresql.org/wiki/YUM_Installation">here</link> in
order to view more detailed notes or install a different version of PostgreSQL.</p>
<p>Locate and edit your distributions .repo file, located:</p>
<list>
<list-item>
On CentOS: /etc/yum.repos.d/CentOS-Base.repo, [base] and [updates] sections
</list-item>
<list-item>
On Red Hat: /etc/yum/pluginconf.d/rhnplugin.conf [main] section
</list-item>
</list>
<p>To the section(s) identified above, you need to append a line (otherwise
dependencies might resolve to the PostgreSQL supplied by the base repository):</p>
<code-block>exclude=postgresql*</code-block>
<p>Next, install the RPM relating to the base operating system and PostgreSQL version
you wish to install. The RPMs can be found <link url="https://yum.postgresql.org/repopackages.php">here</link>.</p>
<p>For example, to install PostgreSQL 10 on a CentOS 7 system:</p>
<code-block>sudo yum -y install https://download.postgresql.org/pub/repos/yum/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm</code-block>
<p>Or to install PostgreSQL 10 on a RHEL 7 system:</p>
<code-block>sudo yum -y install https://download.postgresql.org/pub/repos/yum/testing/10/redhat/rhel-7-x86_64/pgdg-redhat10-10-2.noarch.rpm</code-block>
<p>You&amp;#8217;ll need to update your system:</p>
<code-block>sudo yum -y update</code-block>
<p>Then, go ahead and install the PostgreSQL server package.</p>
<code-block>sudo yum -y install postgresql10-server.x86_64</code-block>
</section>
<section id="_installing_docker">
<title>Installing Docker</title>
<p>As good practice, at this point you&amp;#8217;ll update your system.</p>
<code-block>sudo yum -y update</code-block>
<p>After that, it&amp;#8217;s necessary to add the <b>docker</b> group and give your user access
to that group (here referenced as <b>someuser</b>):</p>
<code-block>sudo groupadd docker
sudo usermod -a -G docker someuser</code-block>
<p>Remember to log out of the <b>someuser</b> account for the Docker group
to be added to your current session.  Once it&amp;#8217;s added, you&amp;#8217;ll be able
to run Docker commands from your user account.</p>
<code-block>su - someuser</code-block>
<p>You can ensure your <b>someuser</b> account is added correctly by running the following
command and ensuring <b>docker</b> appears as one of the results:</p>
<code-block>groups</code-block>
<p>Before you start Docker, you might consider configuring Docker storage:
This is described if you run:</p>
<code-block>man docker-storage-setup</code-block>
<p>Follow the instructions available <link url="https://docs.openshift.com/container-platform/3.4/install_config/install/host_preparation.html#configuring-docker-storage">on the main OpenShift documentation page</link>
to configure Docker storage appropriately.</p>
<p>These steps are illustrative of a typical process for setting up Docker storage. You will need to run these commands as root.</p>
<p>First, add an extra virtual hard disk to your virtual machine (see <link url="http://catlingmindswipe.blogspot.com/2012/02/how-to-create-new-virtual-disks-in.html">this blog post</link> for tips on how to do so).</p>
<p>Run this command to format the drive, where /dev/sd? is the new hard drive that was added:</p>
<code-block>fdisk /dev/sd?</code-block>
<p>Next, create a volume group on the new drive partition within the fdisk utility:</p>
<code-block>vgcreate docker-vg /dev/sd?</code-block>
<p>Then, you&amp;#8217;ll need to edit the docker-storage-setup configuration file in order to override default options. Add these two lines to <b>/etc/sysconfig/docker-storage-setup</b>:</p>
<code-block>DEVS=/dev/sd?
VG=docker-vg</code-block>
<p>Finally, run the command <b>docker-storage-setup</b> to use that new volume group. The results should state that the physical volume /dev/sd? and the volume group docker-vg have both been successfully created.</p>
<p>Next, we enable and start up Docker:</p>
<code-block>sudo systemctl enable docker.service
sudo systemctl start docker.service</code-block>
<p>Verify that Docker version 1.12.6 was installed, as per the OpenShift 3.6
<link url="https://docs.openshift.com/container-platform/3.6/install_config/install/host_preparation.html#installing-docker">requirements.</link></p>
<code-block>docker version</code-block>
</section>
<section id="_build_the_containers">
<title>Build the Containers</title>
<p>At this point, you have a decision to make - either download prebuilt
containers from <link url="https://hub.docker.com/">Dockerhub</link>, <b>or</b> build the containers on your local host.</p>
<p>To download the prebuilt containers, make sure you can login to
<link url="https://hub.docker.com/">Dockerhub</link>, and then run the following:</p>
<code-block>docker login
cd $CCPROOT
./bin/pull-from-dockerhub.sh</code-block>
<p>Or if you&amp;#8217;d rather build the containers from source, perform a container
build as follows:</p>
<code-block>cd $CCPROOT
make setup
make all</code-block>
<p>After this, you will have all the Crunchy containers built and are ready
for use in a <b>standalone Docker</b> environment.</p>
</section>
<section id="_configure_nfs_for_persistence">
<title>Configure NFS for Persistence</title>
<p>NFS is required for some of the examples, including the backup and restore
containers.</p>
<p>First, if you are running your NFS system with SELinux in enforcing mode, you will need to run the following command to allow NFS write permissions:</p>
<code-block>sudo setsebool -P virt_use_nfs 1</code-block>
<p>Detailed instructions that you can use for setting up a NFS server on Centos 7 are provided in the following link.</p>
<p><link url="http://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html">http://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html</link></p>
<p><b>Note</b>: Most of the Crunchy containers run as the postgres UID (26), but you
will notice that when <b>supplementalGroups</b> are specified, the pod
will include the nfsnobody group in the list of groups for the pod user.</p>
<p>The case of Amazon file systems is different, for that you use the
<b>fsGroup</b> security context setting but the idea for allowing
write permissions is the same.</p>
<p>if you are running your client on a VM, you will need to
add <i>insecure</i> to the exportfs file on the NFS server due to the way port
translation is done between the VM host and the VM instance.</p>
<p>For more details on this bug, please see the following link.</p>
<p><link url="http://serverfault.com/questions/107546/mount-nfs-access-denied-by-server-while-mounting">http://serverfault.com/questions/107546/mount-nfs-access-denied-by-server-while-mounting</link></p>
<p>A suggested best practice for tuning NFS for PostgreSQL is to configure the PostgreSQL fstab
mount options like so:</p>
<code-block>proto=tcp,suid,rw,vers=3,proto=tcp,timeo=600,retrans=2,hard,fg,rsize=8192,wsize=8192</code-block>
<p>Network options:</p>
<code-block>MTU=9000</code-block>
<p>If interested in mounting the same NFS share multiple times on the same mount point,
look into the <link url="https://www.novell.com/support/kb/doc.php?id=7010210">noac mount option</link>.</p>
<p>Next, assuming that you are setting up NFS as your storage option, you
will need to run the following script:</p>
<code-block>cd $CCPROOT/examples/pv
./create-pv.sh nfs
./create-pvc.sh</code-block>
<p><b>Note</b>: If you elect to configure HostPath or GCE as your storage option, please view
README.txt for command-line usage for the ./create-pv.sh command.</p>
</section>
</section>
<section id="_openshift_environment">
<title>OpenShift Environment</title>
<section id="_installation">
<title>Installation</title>
<p>See the OpenShift installation guide for details on how to install
OpenShift Enterprise on your host.  The main instructions are here:</p>
<p><link url="https://docs.openshift.com/container-platform/3.6/install_config/install/quick_install.html">https://docs.openshift.com/container-platform/3.6/install_config/install/quick_install.html</link></p>
<p><b>Note:</b> If you install OpenShift Enterprise on a server with less than <code>16GB</code> memory and <code>40GB</code>
of disk, the following Ansible variables need to be added to <code>~/.config/openshift/installer.cfg.yml</code>
prior to installation:</p>
<p>```
openshift_check_min_host_disk_gb: <i>10</i> # min 10gb disk
openshift_check_min_host_memory_gb: <i>3</i> # min 3gb memory
```</p>
<section id="_system_policies_for_pvc_creation_listing">
<title>System policies for PVC creation/listing</title>
<p>In order to allow the <b>system</b> user to be able to create and list
persistent volumes using <b>OpenShift version 3.3+</b>, you have to enter
these commands as the <b>root</b> user after installation in order to
modify the policies.</p>
<code-block>oc adm policy add-role-to-user cluster-reader system
oc adm policy add-cluster-role-to-user cluster-reader system
oc adm policy add-cluster-role-to-user cluster-admin system</code-block>
</section>
</section>
<section id="_anyuid_permissions">
<title>anyuid permissions</title>
<p>One suggested method to use in order to grant a user permission to use the <b>anyuid</b> SCC:</p>
<code-block>oc adm policy add-scc-to-group anyuid system:authenticated</code-block>
<p>This says that any authenticated user can run with the anyuid SCC which lets
them create PVCs and use the <b>fsGroup</b> setting for the PostgreSQL containers to
work using NFS.</p>
</section>
</section>
<section id="_kubernetes_environment">
<title>Kubernetes Environment</title>
<section id="_installation_2">
<title>Installation</title>
<p>See <link url="https://kubernetes.io/docs/setup/independent/install-kubeadm/">kubeadm</link>
for setting up a test environment of Kubernetes.</p>
</section>
<section id="_helm">
<title>Helm</title>
<p><b>Installation</b></p>
<p>Once you have your Kubernetes environment configured, it is simple to get
Helm up and running. Please refer to <link url="https://docs.bitnami.com/kubernetes/get-started-kubernetes/#step-4-install-helm-and-tiller">this document</link>
to get Helm installed and configured properly.</p>
</section>
<section id="_permissions">
<title>Permissions</title>
<p>As of Kubernetes 1.6, RBAC security is enabled on most Kubernetes
installations.  With RBAC, the <b>postgres-operator</b> needs permissions
granted to it to enable ThirdPartyResources viewing.  You can grant the
<b>default</b> Service Account a cluster role as one way to enable
permissions for the operator. This coarse level of granting permissions
is not recommended for production. This command will enable
the <b>default</b> Service Account to have the <b>cluster-admin</b> role:</p>
<code-block>kubectl create clusterrolebinding permissive-binding \
        --clusterrole=cluster-admin \
        --user=admin \
        --user=kubelet \
        --group=system:serviceaccounts:default</code-block>
</section>
<section id="_dns">
<title>DNS</title>
<p>Please see <link url="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">here</link>
to view the official documentation regarding configuring DNS for your Kubernetes cluster.</p>
</section>
<section id="_google_cloud_environment">
<title>Google Cloud Environment</title>
<p>The PostgreSQL Container Suite was tested on Google Container Engine.</p>
<p>Here is a link to set up a Kube cluster on GCE:
<link url="https://kubernetes.io/docs/getting-started-guides/gce">https://kubernetes.io/docs/getting-started-guides/gce</link></p>
<p>Setup the persistent disks using GCE disks by first editing
your <b>bashrc</b> file and export the GCE settings to match your
GCE environment.</p>
<code-block>export GCE_DISK_ZONE=us-central1-a
export GCE_DISK_NAME=gce-disk-crunchy
export GCE_DISK_SIZE=4
export GCE_FS_FORMAT=ext4</code-block>
<p>Then create the PVs used by the examples, passing in the <b>gce</b>
value as a parameter. This will cause the GCE disks to be created:</p>
<code-block>cd $CCPROOT/examples/pv
./create-pv.sh gce
cd $CCPROOT/examples/pv
./create-pvc.sh</code-block>
<p>Here is a link that describes more information on GCE persistent disk:
<link url="https://cloud.google.com/container-engine/docs/tutorials/persistent-disk/">https://cloud.google.com/container-engine/docs/tutorials/persistent-disk/</link></p>
<p>To have the persistent disk examples work, you will need to specify
a <b>fsGroup</b> setting in the <b>SecurityContext</b> of each pod script
as follows:</p>
<code-block>       "securityContext": {
        "fsGroup": 26
        },</code-block>
<p>For our PostgreSQL container, a UID of 26 is specified as the user
which corresponds to the <b>fsGroup</b> value.</p>
</section>
<section id="_tips">
<title>Tips</title>
<p>Make sure your hostname resolves to a single IP address in your
/etc/hosts file. The NFS examples will not work otherwise and other problems
with installation can occur unless you have a resolving hostname.</p>
<p>You should see a single IP address returned from this command:</p>
<code-block>hostname --ip-address</code-block>
</section>
</section>
<section id="_legal_notices">
<title>Legal Notices</title>
<p>Copyright &amp;#169; 2017 Crunchy Data Solutions, Inc.</p>
<p>CRUNCHY DATA SOLUTIONS, INC. PROVIDES THIS GUIDE <quote>AS IS</quote> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</p>
<p>Crunchy, Crunchy Data Solutions, Inc. and the Crunchy Hippo Logo are trademarks of Crunchy Data Solutions, Inc.</p>
</section>
</doc>
